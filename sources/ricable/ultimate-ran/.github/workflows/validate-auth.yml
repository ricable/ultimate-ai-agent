name: Validate Authentication Configuration

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'config/.env.template'
      - 'config/agentic-flow.config.ts'
      - 'scripts/validate-auth.sh'
      - '.github/workflows/validate-auth.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-config:
    name: Validate OAuth Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check .env.template format
        run: |
          echo "Validating .env.template format..."

          # Check for required OAuth sections
          if ! grep -q "CLAUDE_CODE_OAUTH_TOKEN" config/.env.template; then
            echo "❌ Missing CLAUDE_CODE_OAUTH_TOKEN in .env.template"
            exit 1
          fi

          if ! grep -q "GOOGLE_OAUTH_CLIENT_ID" config/.env.template; then
            echo "❌ Missing GOOGLE_OAUTH_CLIENT_ID in .env.template"
            exit 1
          fi

          if ! grep -q "gemini-3-pro-preview" config/.env.template; then
            echo "❌ Missing latest Gemini model in .env.template"
            exit 1
          fi

          if ! grep -q "claude-opus-4-5-20251101" config/.env.template; then
            echo "❌ Missing latest Claude model in .env.template"
            exit 1
          fi

          echo "✅ .env.template format valid"

      - name: Validate TypeScript config
        run: |
          echo "Validating agentic-flow.config.ts..."
          npm run build
          echo "✅ TypeScript configuration builds successfully"

      - name: Check for hardcoded API keys
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check for patterns that look like API keys (excluding template)
          if grep -r "sk-ant-api03-[a-zA-Z0-9]" --include="*.ts" --include="*.js" src/; then
            echo "❌ Found hardcoded Anthropic API key"
            exit 1
          fi

          if grep -r "AIzaSy[a-zA-Z0-9_-]" --include="*.ts" --include="*.js" src/; then
            echo "❌ Found hardcoded Google API key"
            exit 1
          fi

          echo "✅ No hardcoded secrets found"

      - name: Validate script executability
        run: |
          echo "Checking script permissions..."

          if [ ! -x scripts/validate-auth.sh ]; then
            echo "❌ validate-auth.sh not executable"
            exit 1
          fi

          if [ ! -x scripts/setup-oauth.sh ]; then
            echo "❌ setup-oauth.sh not executable"
            exit 1
          fi

          echo "✅ All scripts are executable"

      - name: Test validation script (dry-run)
        run: |
          echo "Testing validation script..."

          # Create mock .env for testing
          cp config/.env.template config/.env

          # The script should warn about missing OAuth but not fail
          ./scripts/validate-auth.sh || true

          echo "✅ Validation script runs without errors"

      - name: Check documentation
        run: |
          echo "Validating documentation..."

          if [ ! -f docs/OAUTH-SETUP-GUIDE.md ]; then
            echo "❌ Missing OAuth setup guide"
            exit 1
          fi

          if [ ! -f scripts/README.md ]; then
            echo "❌ Missing scripts README"
            exit 1
          fi

          echo "✅ Documentation present"

      - name: Summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Authentication Configuration Valid"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "OAuth support configured for:"
          echo "  • Claude Opus 4.5 (claude-opus-4-5-20251101)"
          echo "  • Gemini 3 Pro (gemini-3-pro-preview)"
          echo ""
          echo "Scripts available:"
          echo "  • npm run auth:setup"
          echo "  • npm run auth:validate"
          echo "  • npm run auth:preflight"
          echo ""
