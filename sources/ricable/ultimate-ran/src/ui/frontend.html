<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TITAN RAN Dashboard - AG-UI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #2ECC71;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .stats {
      display: flex;
      gap: 20px;
      font-size: 14px;
    }

    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-label {
      color: #999;
      font-size: 11px;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #667eea;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .cell-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .cell-table th {
      background: #f5f5f5;
      padding: 8px;
      text-align: left;
      font-weight: bold;
      color: #666;
    }

    .cell-table td {
      padding: 8px;
      border-bottom: 1px solid #f0f0f0;
      font-family: 'Courier New', monospace;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-degraded {
      background: #fff3cd;
      color: #856404;
    }

    .status-outage {
      background: #f8d7da;
      color: #721c24;
    }

    .event-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      font-size: 13px;
    }

    .event-type {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 4px;
    }

    .event-time {
      font-size: 11px;
      color: #999;
    }

    .approval-card {
      border: 2px solid #FFA500;
      background: #FFF9E6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .approval-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .risk-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      color: white;
    }

    .risk-low {
      background: #2ECC71;
    }

    .risk-medium {
      background: #FFA500;
    }

    .risk-high {
      background: #E74C3C;
    }

    .risk-critical {
      background: #8B0000;
    }

    .approval-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
    }

    .btn-approve {
      background: #2ECC71;
      color: white;
    }

    .btn-reject {
      background: #E74C3C;
      color: white;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .kpi-item {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 6px;
    }

    .kpi-label {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      font-family: 'Courier New', monospace;
    }

    .connection-status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }

    .connected {
      background: #d4edda;
      color: #155724;
    }

    .disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    #log {
      background: #1e1e1e;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-line {
      margin-bottom: 4px;
    }

    .form-select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      flex: 1;
      background: white;
      cursor: pointer;
    }

    .agent-card {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      position: relative;
    }

    .agent-card.claude {
      border-color: #667eea;
    }

    .agent-card.gemini {
      border-color: #4285f4;
    }

    .agent-card.busy {
      background: #fff9e6;
      border-color: #FFA500;
    }

    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .agent-name {
      font-weight: bold;
      color: #667eea;
      font-size: 13px;
    }

    .agent-status-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .agent-status-idle {
      background: #d4edda;
      color: #155724;
    }

    .agent-status-busy {
      background: #fff3cd;
      color: #856404;
    }

    .agent-role {
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
    }

    .agent-stats {
      font-size: 11px;
      color: #666;
    }

    .consensus-card {
      background: #f0f8ff;
      border: 2px solid #4285f4;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .vote-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
    }

    .vote-approve {
      color: #2ECC71;
      font-weight: bold;
    }

    .vote-reject {
      color: #E74C3C;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>
        <span class="status-indicator"></span>
        TITAN RAN Dashboard
      </h1>
      <div class="stats">
        <div class="stat">
          <span class="stat-label">Cells</span>
          <span class="stat-value" id="cell-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Alarms</span>
          <span class="stat-value" id="alarm-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Events</span>
          <span class="stat-value" id="event-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Approvals</span>
          <span class="stat-value" id="approval-count">0</span>
        </div>
      </div>
    </div>

    <!-- Connection Status -->
    <div class="card">
      <h2>üîå SSE Connection Status</h2>
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div id="kpi-status" class="connection-status disconnected">KPI Stream: Disconnected</div>
        <div id="event-status" class="connection-status disconnected">Event Stream: Disconnected</div>
        <div id="alarm-status" class="connection-status disconnected">Alarm Stream: Disconnected</div>
        <div id="approval-status" class="connection-status disconnected">Approval Stream: Disconnected</div>
      </div>
    </div>

    <!-- AI Swarm Status -->
    <div class="card">
      <h2>ü§ñ AI Agent Swarm - Consensus Reasoning</h2>
      <div style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <select id="swarm-topology" class="form-select">
            <option value="consensus">Consensus (Recommended)</option>
            <option value="hierarchical">Hierarchical</option>
            <option value="mesh">Mesh Network</option>
          </select>
          <button class="btn" style="background: #667eea; color: white;" onclick="initializeSwarm()">Initialize Swarm</button>
          <button class="btn" style="background: #E74C3C; color: white;" onclick="resetSwarm()">Reset</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
          <div class="kpi-item">
            <div class="kpi-label">Total Agents</div>
            <div class="kpi-value" id="swarm-total">0</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Active</div>
            <div class="kpi-value" style="color: #2ECC71;" id="swarm-active">0</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Busy</div>
            <div class="kpi-value" style="color: #FFA500;" id="swarm-busy">0</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Topology</div>
            <div class="kpi-value" style="font-size: 14px;" id="swarm-topology-display">-</div>
          </div>
        </div>
      </div>

      <!-- Agent Cards -->
      <div id="agent-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <p style="text-align: center; color: #999;">Initialize swarm to see agents</p>
      </div>
    </div>

    <!-- Consensus History -->
    <div class="card">
      <h2>üéØ Consensus Reasoning History</h2>
      <div id="consensus-history">
        <p style="text-align: center; color: #999;">No consensus decisions yet</p>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid">
      <!-- Cell Status -->
      <div class="card">
        <h2>üì° Cell Status</h2>
        <table class="cell-table">
          <thead>
            <tr>
              <th>Cell ID</th>
              <th>Status</th>
              <th>RSRP</th>
              <th>SINR</th>
              <th>PRB%</th>
            </tr>
          </thead>
          <tbody id="cell-tbody">
            <tr>
              <td colspan="5" style="text-align: center; color: #999;">No data available</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Recent Events -->
      <div class="card">
        <h2>‚ö° Recent Events</h2>
        <div class="event-list" id="event-list">
          <p style="text-align: center; color: #999;">No events yet</p>
        </div>
      </div>

      <!-- KPI Metrics -->
      <div class="card">
        <h2>üìä Live KPI Metrics</h2>
        <div class="kpi-grid">
          <div class="kpi-item">
            <div class="kpi-label">Avg RSRP</div>
            <div class="kpi-value" id="avg-rsrp">-- dBm</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Avg SINR</div>
            <div class="kpi-value" id="avg-sinr">-- dB</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Avg Throughput</div>
            <div class="kpi-value" id="avg-throughput">-- Mbps</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Avg PRB Usage</div>
            <div class="kpi-value" id="avg-prb">-- %</div>
          </div>
        </div>
      </div>

      <!-- Pending Approvals -->
      <div class="card">
        <h2>‚úã Pending Approvals</h2>
        <div id="approval-list">
          <p style="text-align: center; color: #999;">No pending approvals</p>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="card">
      <h2>üìã Event Log</h2>
      <div id="log"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';
    let eventSources = {};
    let cells = new Map();
    let events = [];
    let alarms = [];
    let approvals = [];

    // Logging
    function log(message) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.className = 'log-line';
      line.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;

      // Keep only last 100 lines
      while (logDiv.children.length > 100) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    // Connect to SSE streams
    function connectStreams() {
      log('Connecting to SSE streams...');

      // KPI Stream
      const kpiSource = new EventSource(`${API_BASE}/api/stream/kpi`);
      kpiSource.onopen = () => {
        log('KPI stream connected');
        document.getElementById('kpi-status').className = 'connection-status connected';
        document.getElementById('kpi-status').textContent = 'KPI Stream: Connected';
      };
      kpiSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'kpi_update') {
          handleKPIUpdate(data);
        }
      };
      kpiSource.onerror = () => {
        log('KPI stream error');
        document.getElementById('kpi-status').className = 'connection-status disconnected';
        document.getElementById('kpi-status').textContent = 'KPI Stream: Disconnected';
      };

      // Event Stream
      const eventSource = new EventSource(`${API_BASE}/api/stream/events`);
      eventSource.onopen = () => {
        log('Event stream connected');
        document.getElementById('event-status').className = 'connection-status connected';
        document.getElementById('event-status').textContent = 'Event Stream: Connected';
      };
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'optimization_events') {
          handleEventUpdate(data.events);
        }
      };

      // Alarm Stream
      const alarmSource = new EventSource(`${API_BASE}/api/stream/alarms`);
      alarmSource.onopen = () => {
        log('Alarm stream connected');
        document.getElementById('alarm-status').className = 'connection-status connected';
        document.getElementById('alarm-status').textContent = 'Alarm Stream: Connected';
      };
      alarmSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'alarm_added') {
          log(`Alarm raised: ${data.alarm.alarm_text}`);
          alarms.push(data.alarm);
          updateAlarmCount();
        } else if (data.type === 'alarm_cleared') {
          log(`Alarm cleared: ${data.alarm.alarm_text}`);
          alarms = alarms.filter(a => a.id !== data.alarm.id);
          updateAlarmCount();
        }
      };

      // Approval Stream
      const approvalSource = new EventSource(`${API_BASE}/api/stream/approvals`);
      approvalSource.onopen = () => {
        log('Approval stream connected');
        document.getElementById('approval-status').className = 'connection-status connected';
        document.getElementById('approval-status').textContent = 'Approval Stream: Connected';
      };
      approvalSource.onerror = () => {
        document.getElementById('approval-status').className = 'connection-status disconnected';
        document.getElementById('approval-status').textContent = 'Approval Stream: Disconnected';
      };
      approvalSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'approval_queue_update') {
          handleApprovalUpdate(data.approvals);
        }
      };

      eventSources = { kpiSource, eventSource, alarmSource, approvalSource };
    }

    // Handle KPI updates
    function handleKPIUpdate(data) {
      if (!data.counters) return;

      const cellKPIs = new Map();
      data.counters.forEach(counter => {
        if (!cellKPIs.has(counter.cell_id)) {
          cellKPIs.set(counter.cell_id, {});
        }
        cellKPIs.get(counter.cell_id)[counter.counter_name] = counter.value;
      });

      const count = cellKPIs.size;
      if (count === 0) return;

      // Update stats
      const avgRSRP = data.counters.filter(c => c.counter_name === 'rsrp_avg')
        .reduce((sum, c) => sum + c.value, 0) / count;
      const avgSINR = data.counters.filter(c => c.counter_name === 'sinr_avg')
        .reduce((sum, c) => sum + c.value, 0) / count;
      const avgThroughput = data.counters.filter(c => c.counter_name === 'throughput_mbps')
        .reduce((sum, c) => sum + c.value, 0) / count;
      const avgPRB = data.counters.filter(c => c.counter_name === 'prb_utilization')
        .reduce((sum, c) => sum + c.value, 0) / count;

      document.getElementById('avg-rsrp').textContent = avgRSRP.toFixed(1) + ' dBm';
      document.getElementById('avg-sinr').textContent = avgSINR.toFixed(1) + ' dB';
      document.getElementById('avg-throughput').textContent = avgThroughput.toFixed(1) + ' Mbps';
      document.getElementById('avg-prb').textContent = avgPRB.toFixed(0) + ' %';

      log(`KPI update: ${count} cells`);
    }

    // Handle event updates
    function handleEventUpdate(newEvents) {
      events = newEvents.slice(0, 10);
      renderEvents();
      document.getElementById('event-count').textContent = newEvents.length;
    }

    // Handle approval updates
    function handleApprovalUpdate(newApprovals) {
      approvals = newApprovals;
      renderApprovals();
      document.getElementById('approval-count').textContent = approvals.filter(a => a.status === 'pending').length;
    }

    function updateAlarmCount() {
      document.getElementById('alarm-count').textContent = alarms.length;
    }

    // Render events
    function renderEvents() {
      const eventList = document.getElementById('event-list');
      eventList.innerHTML = '';

      if (events.length === 0) {
        eventList.innerHTML = '<p style="text-align: center; color: #999;">No events yet</p>';
        return;
      }

      events.forEach(event => {
        const div = document.createElement('div');
        div.className = 'event-item';
        div.innerHTML = `
          <div class="event-type">${event.event_type.replace(/_/g, ' ').toUpperCase()}</div>
          <div>${event.reasoning}</div>
          <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
        `;
        eventList.appendChild(div);
      });
    }

    // Render approvals
    function renderApprovals() {
      const list = document.getElementById('approval-list');
      list.innerHTML = '';

      const pending = approvals.filter(a => a.status === 'pending');

      if (pending.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999;">No pending approvals</p>';
        return;
      }

      pending.sort((a, b) => b.created_at.localeCompare(a.created_at));

      pending.forEach(approval => {
        const div = document.createElement('div');
        div.className = 'approval-card';
        div.innerHTML = `
          <div class="approval-header">
            <span class="risk-badge risk-${approval.risk_level}">${approval.risk_level.toUpperCase()}</span>
            <small>${new Date(approval.created_at).toLocaleTimeString()}</small>
          </div>
          <div style="font-weight: bold; margin-bottom: 5px;">${approval.action}</div>
          <div style="font-size: 12px; margin-bottom: 5px;">Target: ${approval.target.join(', ')}</div>
          <div style="font-style: italic; font-size: 12px; color: #666;">"${approval.justification}"</div>
          <div class="approval-actions">
            <button class="btn btn-approve" onclick="approveAction('${approval.id}')">APPROVE</button>
            <button class="btn btn-reject" onclick="rejectAction('${approval.id}')">REJECT</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.approveAction = async function (id) {
      try {
        await fetch(`${API_BASE}/api/approvals/${id}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signature: 'admin-user' })
        });
        log(`Approved action ${id}`);
        loadInitialData();
      } catch (e) {
        log(`Error approving: ${e.message}`);
      }
    };

    window.rejectAction = async function (id) {
      try {
        await fetch(`${API_BASE}/api/approvals/${id}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signature: 'admin-user' })
        });
        log(`Rejected action ${id}`);
        loadInitialData();
      } catch (e) {
        log(`Error rejecting: ${e.message}`);
      }
    };

    // Load initial data
    async function loadInitialData() {
      try {
        // Cells
        const cellRes = await fetch(`${API_BASE}/api/cells`);
        const cellData = await cellRes.json();
        if (cellData.cells) {
          document.getElementById('cell-count').textContent = cellData.cells.length;
          const tbody = document.getElementById('cell-tbody');
          tbody.innerHTML = '';
          cellData.cells.forEach(cell => {
            const row = tbody.insertRow();
            row.innerHTML = `
               <td>${cell.cell_id}</td>
               <td><span class="status-badge status-${cell.status}">${cell.status}</span></td>
               <td>${cell.kpi.rsrp_avg.toFixed(1)}</td>
               <td>${cell.kpi.sinr_avg.toFixed(1)}</td>
               <td>${cell.kpi.prb_utilization.toFixed(0)}%</td>
             `;
          });
          log(`Loaded ${cellData.cells.length} cells`);
        }

        // Alarms
        const alarmRes = await fetch(`${API_BASE}/api/alarms`);
        const alarmData = await alarmRes.json();
        if (alarmData.alarms) {
          alarms = alarmData.alarms;
          updateAlarmCount();
          log(`Loaded ${alarms.length} alarms`);
        }

        // Events
        const eventRes = await fetch(`${API_BASE}/api/optimization/events`);
        const eventData = await eventRes.json();
        if (eventData.events) {
          handleEventUpdate(eventData.events);
          log(`Loaded ${eventData.events.length} events`);
        }

        // Approvals
        const approvalRes = await fetch(`${API_BASE}/api/approvals`);
        const approvalData = await approvalRes.json();
        if (approvalData.approvals) {
          handleApprovalUpdate(approvalData.approvals);
          log(`Loaded ${approvalData.approvals.length} approvals`);
        }
      } catch (error) {
        log(`Error loading initial data: ${error.message}`);
      }
    }

    // ========================================================================
    // AI Swarm Management
    // ========================================================================

    let swarmInitialized = false;

    window.initializeSwarm = async function() {
      try {
        const topology = document.getElementById('swarm-topology').value;
        log(`Initializing AI swarm with ${topology} topology...`);

        const response = await fetch(`${API_BASE}/api/swarm/init`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topology })
        });

        const data = await response.json();

        if (data.success) {
          swarmInitialized = true;
          log(`‚úÖ Swarm initialized: ${data.agents} agents ready`);
          await updateSwarmStatus();

          // Start polling for swarm status
          setInterval(updateSwarmStatus, 5000);
        } else {
          log(`‚ùå Swarm initialization failed: ${data.error}`);
        }
      } catch (error) {
        log(`Error initializing swarm: ${error.message}`);
      }
    };

    window.resetSwarm = async function() {
      try {
        log('Resetting AI swarm...');
        const response = await fetch(`${API_BASE}/api/swarm/reset`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          log('‚úÖ Swarm reset complete');
          swarmInitialized = false;
          document.getElementById('agent-cards').innerHTML = '<p style="text-align: center; color: #999;">Initialize swarm to see agents</p>';
          document.getElementById('swarm-total').textContent = '0';
          document.getElementById('swarm-active').textContent = '0';
          document.getElementById('swarm-busy').textContent = '0';
        }
      } catch (error) {
        log(`Error resetting swarm: ${error.message}`);
      }
    };

    async function updateSwarmStatus() {
      if (!swarmInitialized) return;

      try {
        const response = await fetch(`${API_BASE}/api/swarm/status`);
        const status = await response.json();

        // Update summary stats
        document.getElementById('swarm-total').textContent = status.totalAgents;
        document.getElementById('swarm-active').textContent = status.activeAgents;
        document.getElementById('swarm-busy').textContent = status.busyAgents;
        document.getElementById('swarm-topology-display').textContent = status.topology.toUpperCase();

        // Render agent cards
        renderAgentCards(status.agents);

        // Render consensus history
        if (status.consensusHistory && status.consensusHistory.length > 0) {
          renderConsensusHistory(status.consensusHistory);
        }
      } catch (error) {
        console.error('Error updating swarm status:', error);
      }
    }

    function renderAgentCards(agents) {
      const container = document.getElementById('agent-cards');
      container.innerHTML = '';

      agents.forEach(agent => {
        const card = document.createElement('div');
        card.className = `agent-card ${agent.type} ${agent.status}`;

        const statusClass = agent.status === 'idle' ? 'agent-status-idle' : 'agent-status-busy';

        card.innerHTML = `
          <div class="agent-header">
            <span class="agent-name">${agent.id}</span>
            <span class="agent-status-badge ${statusClass}">${agent.status}</span>
          </div>
          <div class="agent-role">${agent.role.replace('_', ' ').toUpperCase()}</div>
          <div class="agent-stats">
            <div>Confidence: ${(agent.confidence * 100).toFixed(0)}%</div>
            <div>Tasks: ${agent.tasksCompleted}</div>
            ${agent.currentTask ? `<div style="color: #FFA500; font-weight: bold;">Task: ${agent.currentTask}</div>` : ''}
          </div>
        `;

        container.appendChild(card);
      });
    }

    function renderConsensusHistory(history) {
      const container = document.getElementById('consensus-history');
      container.innerHTML = '';

      history.slice().reverse().forEach(consensus => {
        const card = document.createElement('div');
        card.className = 'consensus-card';

        const decisionColor = consensus.decision === 'approved' ? '#2ECC71' :
                             consensus.decision === 'rejected' ? '#E74C3C' : '#FFA500';

        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong style="color: ${decisionColor}">${consensus.decision.toUpperCase()}</strong>
            <span style="font-size: 11px; color: #999;">${new Date(consensus.timestamp).toLocaleTimeString()}</span>
          </div>
          <div style="margin-bottom: 8px; font-size: 12px;">
            Confidence: ${(consensus.confidence * 100).toFixed(1)}% |
            Votes: ${consensus.votes.length} agents
          </div>
          <div style="border-top: 1px solid #e0e0e0; padding-top: 8px;">
            ${consensus.votes.map(vote => `
              <div class="vote-item">
                <span>${vote.agent_id}</span>
                <span class="${vote.vote ? 'vote-approve' : 'vote-reject'}">
                  ${vote.vote ? 'APPROVE' : 'REJECT'} (${(vote.confidence * 100).toFixed(0)}%)
                </span>
              </div>
            `).join('')}
          </div>
        `;

        container.appendChild(card);
      });
    }

    // ========================================================================
    // Initialize
    // ========================================================================

    log('TITAN Dashboard initializing...');
    loadInitialData();
    connectStreams();

    // Check if swarm API keys are configured
    log('AI Swarm Coordinator available. Configure API keys and click "Initialize Swarm"');
  </script>
</body>

</html>