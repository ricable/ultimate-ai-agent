# mise.toml - Infrastructure Agent Category Configuration
# For Kubernetes operators, controllers, and infrastructure services
# https://mise.jdx.dev/

[env]
# Infrastructure-specific environment
AGENT_CATEGORY = "infrastructure"

# Kubernetes configuration
KUBECONFIG = "{{env.HOME}}/.kube/config"
KUBECTL_EXTERNAL_DIFF = "diff"

# Helm configuration
HELM_CACHE_HOME = "{{env.HOME}}/.cache/helm"
HELM_CONFIG_HOME = "{{env.HOME}}/.config/helm"
HELM_DATA_HOME = "{{env.HOME}}/.local/share/helm"

# K3s configuration
K3S_KUBECONFIG_MODE = "644"

# Container registry
REGISTRY = "ghcr.io/ruvnet"

_.path = [
  "{{config_root}}/scripts",
  "{{env.HOME}}/.local/bin"
]

[tools]
# Kubernetes tooling
kubectl = "latest"
helm = "latest"
k9s = "latest"
kustomize = "latest"

# Container tools
"cargo:kubeval" = "latest"

# Development
node = "22"
go = "1.22"

# Infrastructure as Code
terraform = "latest"

[settings]
jobs = 4

# =============================================================================
# KUBERNETES MANAGEMENT TASKS
# =============================================================================

[tasks.k8s-apply]
description = "Apply Kubernetes manifests"
run = """
#!/usr/bin/env bash
set -euo pipefail

NAMESPACE=${NAMESPACE:-"default"}
PATH_ARG=${1:-"."}

echo "ðŸš€ Applying Kubernetes manifests from $PATH_ARG..."

if [ -f "$PATH_ARG/kustomization.yaml" ]; then
  kubectl apply -k "$PATH_ARG" -n "$NAMESPACE"
else
  kubectl apply -f "$PATH_ARG" -n "$NAMESPACE"
fi

echo "âœ… Manifests applied"
"""

[tasks.k8s-delete]
description = "Delete Kubernetes resources"
run = """
#!/usr/bin/env bash
PATH_ARG=${1:-"."}
NAMESPACE=${NAMESPACE:-"default"}

if [ -f "$PATH_ARG/kustomization.yaml" ]; then
  kubectl delete -k "$PATH_ARG" -n "$NAMESPACE"
else
  kubectl delete -f "$PATH_ARG" -n "$NAMESPACE"
fi
"""

[tasks.k8s-status]
description = "Show cluster status"
run = """
#!/usr/bin/env bash
echo "ðŸ“Š Cluster Status"
echo "================"
kubectl cluster-info
echo ""
echo "Nodes:"
kubectl get nodes -o wide
echo ""
echo "Pods (all namespaces):"
kubectl get pods -A
"""

[tasks.k8s-logs]
description = "Stream logs from pod"
run = """
#!/usr/bin/env bash
POD=${1:?"Usage: mise run k8s-logs <pod-name>"}
kubectl logs -f "$POD"
"""

[tasks.k8s-shell]
description = "Open shell in pod"
run = """
#!/usr/bin/env bash
POD=${1:?"Usage: mise run k8s-shell <pod-name>"}
kubectl exec -it "$POD" -- /bin/sh
"""

# =============================================================================
# K3S CLUSTER TASKS
# =============================================================================

[tasks.k3s-install]
description = "Install K3s server"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "â˜ï¸  Installing K3s server..."

curl -sfL https://get.k3s.io | sh -s - server \
  --disable traefik \
  --disable servicelb \
  --flannel-backend wireguard-native

echo "âœ… K3s installed"
echo "KUBECONFIG: /etc/rancher/k3s/k3s.yaml"
"""

[tasks.k3s-agent]
description = "Install K3s agent and join cluster"
run = """
#!/usr/bin/env bash
K3S_URL=${K3S_URL:?"Set K3S_URL"}
K3S_TOKEN=${K3S_TOKEN:?"Set K3S_TOKEN"}

curl -sfL https://get.k3s.io | K3S_URL="$K3S_URL" K3S_TOKEN="$K3S_TOKEN" sh -
"""

[tasks.k3s-token]
description = "Get K3s join token"
run = "sudo cat /var/lib/rancher/k3s/server/node-token"

[tasks.k3s-uninstall]
description = "Uninstall K3s"
run = """
#!/usr/bin/env bash
/usr/local/bin/k3s-uninstall.sh 2>/dev/null || true
/usr/local/bin/k3s-agent-uninstall.sh 2>/dev/null || true
echo "âœ… K3s uninstalled"
"""

# =============================================================================
# KAGENTI OPERATOR TASKS
# =============================================================================

[tasks.kagenti-install]
description = "Install kagenti-operator"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ¤– Installing kagenti-operator..."

helm repo add kagenti https://kagenti.github.io/charts 2>/dev/null || true
helm repo update

helm upgrade --install kagenti-operator kagenti/kagenti-operator \
  --namespace kagenti-system \
  --create-namespace \
  --wait

echo "âœ… kagenti-operator installed"
kubectl get pods -n kagenti-system
"""

[tasks.kagenti-platform-create]
description = "Create a Platform CR"
run = """
#!/usr/bin/env bash
PLATFORM_NAME=${1:?"Usage: mise run kagenti-platform-create <name>"}

cat << EOF | kubectl apply -f -
apiVersion: kagenti.io/v1alpha1
kind: Platform
metadata:
  name: $PLATFORM_NAME
  namespace: default
spec:
  components:
    - name: infrastructure
      type: Infrastructure
      order: 1
    - name: tools
      type: Tool
      order: 2
    - name: agents
      type: Agent
      order: 3
EOF

echo "âœ… Platform $PLATFORM_NAME created"
"""

[tasks.kagenti-component-create]
description = "Create a Component CR"
run = """
#!/usr/bin/env bash
COMPONENT_NAME=${1:?"Usage: mise run kagenti-component-create <name> <type>"}
COMPONENT_TYPE=${2:-"Agent"}

cat << EOF | kubectl apply -f -
apiVersion: kagenti.io/v1alpha1
kind: Component
metadata:
  name: $COMPONENT_NAME
  namespace: default
spec:
  type: $COMPONENT_TYPE
  source:
    git:
      url: "https://github.com/ruvnet/zgents"
      path: "agents/$COMPONENT_TYPE/$COMPONENT_NAME"
  build:
    enabled: true
EOF

echo "âœ… Component $COMPONENT_NAME created"
"""

[tasks.kagenti-status]
description = "Check kagenti resources status"
run = """
#!/usr/bin/env bash
echo "ðŸ“Š kagenti Status"
echo "================"
echo ""
echo "Platforms:"
kubectl get platforms -A 2>/dev/null || echo "  No platforms found"
echo ""
echo "Components:"
kubectl get components -A 2>/dev/null || echo "  No components found"
echo ""
echo "Operator Pods:"
kubectl get pods -n kagenti-system
"""

# =============================================================================
# HELM MANAGEMENT TASKS
# =============================================================================

[tasks.helm-deps]
description = "Update Helm dependencies"
run = """
#!/usr/bin/env bash
CHART_PATH=${1:-"charts"}
helm dependency update "$CHART_PATH"
"""

[tasks.helm-lint]
description = "Lint Helm chart"
run = """
#!/usr/bin/env bash
CHART_PATH=${1:-"charts"}
helm lint "$CHART_PATH"
"""

[tasks.helm-template]
description = "Render Helm templates"
run = """
#!/usr/bin/env bash
CHART_PATH=${1:-"charts"}
helm template test "$CHART_PATH"
"""

[tasks.helm-install]
description = "Install Helm chart"
run = """
#!/usr/bin/env bash
RELEASE=${1:?"Usage: mise run helm-install <release-name> <chart-path>"}
CHART=${2:?"Usage: mise run helm-install <release-name> <chart-path>"}

helm upgrade --install "$RELEASE" "$CHART" --wait
"""

# =============================================================================
# SPINKUBE TASKS
# =============================================================================

[tasks.spinkube-install]
description = "Install SpinKube operator"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸŒ€ Installing SpinKube..."

# Install cert-manager (required)
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.0/cert-manager.yaml
kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-webhook -n cert-manager

# Install runtime class manager
kubectl apply -f https://github.com/spinkube/runtime-class-manager/releases/download/v0.3.0/runtime-class-manager.yaml

# Install spin-operator
helm repo add spinkube https://spinkube.github.io/spin-operator
helm install spin-operator spinkube/spin-operator \
  --namespace spin-operator \
  --create-namespace \
  --set controllerManager.manager.spinApp.enabled=true

# Create SpinAppExecutor
kubectl apply -f - << EOF
apiVersion: core.spinkube.dev/v1alpha1
kind: SpinAppExecutor
metadata:
  name: containerd-shim-spin
spec:
  createDeployment: true
  deploymentConfig:
    runtimeClassName: wasmtime-spin
EOF

echo "âœ… SpinKube installed"
"""

[tasks.spinapp-deploy]
description = "Deploy SpinApp"
run = """
#!/usr/bin/env bash
APP_NAME=${1:?"Usage: mise run spinapp-deploy <name> <image>"}
IMAGE=${2:?"Usage: mise run spinapp-deploy <name> <image>"}

kubectl apply -f - << EOF
apiVersion: core.spinkube.dev/v1alpha1
kind: SpinApp
metadata:
  name: $APP_NAME
spec:
  image: "$IMAGE"
  executor: containerd-shim-spin
  replicas: 2
EOF

echo "âœ… SpinApp $APP_NAME deployed"
"""

# =============================================================================
# RUNTIME CLASS MANAGER TASKS
# =============================================================================

[tasks.shim-install]
description = "Install containerd shims"
run = """
#!/usr/bin/env bash
set -euo pipefail

ARCH=$(uname -m)

echo "ðŸ“¦ Installing containerd shims for $ARCH..."

# Spin shim
if [ "$ARCH" = "aarch64" ]; then
  SPIN_URL="https://github.com/spinkube/containerd-shim-spin/releases/latest/download/containerd-shim-spin-v2-linux-aarch64.tar.gz"
else
  SPIN_URL="https://github.com/spinkube/containerd-shim-spin/releases/latest/download/containerd-shim-spin-v2-linux-x86_64.tar.gz"
fi

curl -L "$SPIN_URL" | sudo tar xz -C /usr/local/bin
sudo chmod +x /usr/local/bin/containerd-shim-spin-v2

echo "âœ… Shims installed"
"""

[tasks.runtime-class-create]
description = "Create RuntimeClass for WASM"
run = """
#!/usr/bin/env bash

kubectl apply -f - << EOF
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: wasmtime-spin
handler: spin
scheduling:
  nodeSelector:
    kubernetes.io/arch: amd64
EOF

echo "âœ… RuntimeClass wasmtime-spin created"
"""

# =============================================================================
# VALIDATION TASKS
# =============================================================================

[tasks.validate]
description = "Validate Kubernetes manifests"
run = """
#!/usr/bin/env bash
PATH_ARG=${1:-"k8s"}

echo "ðŸ” Validating Kubernetes manifests..."

# Dry run
kubectl apply --dry-run=client -f "$PATH_ARG"

# Kubeval if available
if command -v kubeval &> /dev/null; then
  kubeval "$PATH_ARG"/*.yaml
fi

echo "âœ… Validation complete"
"""

[tasks.template]
description = "Create new infrastructure component"
run = """
#!/usr/bin/env bash
COMPONENT_NAME=${1:?"Usage: mise run template <name>"}

mkdir -p "$COMPONENT_NAME"/{k8s,charts}

# Create kustomization.yaml
cat > "$COMPONENT_NAME/k8s/kustomization.yaml" << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources: []
EOF

# Create mise.toml
cat > "$COMPONENT_NAME/mise.toml" << EOF
# Infrastructure component: $COMPONENT_NAME
[env]
COMPONENT_NAME = "$COMPONENT_NAME"
EOF

echo "âœ… Infrastructure component created at $COMPONENT_NAME/"
"""
