name: NAPI Test

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'qudag/qudag-napi/**'
      - 'qudag/core/**'
      - '.github/workflows/napi-test.yml'
  push:
    branches: [main, develop]
    paths:
      - 'qudag/qudag-napi/**'
      - 'qudag/core/**'
      - '.github/workflows/napi-test.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: qudag/qudag-napi

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Check Rust formatting
      working-directory: qudag/qudag-napi
      run: cargo fmt --all -- --check

    - name: Run Clippy
      working-directory: qudag/qudag-napi
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Install dependencies
      working-directory: qudag/qudag-napi
      run: npm ci

    - name: Check TypeScript types
      working-directory: qudag/qudag-napi
      run: |
        # Generate type definitions if they exist
        if [ -f "index.d.ts" ]; then
          echo "Type definitions found"
        fi

  test:
    name: Test - Node ${{ matrix.node }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: ['18', '20', '22']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js ${{ matrix.node }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'npm'
        cache-dependency-path: qudag/qudag-napi/package-lock.json

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: test-${{ matrix.os }}-node${{ matrix.node }}
        workspaces: qudag/qudag-napi

    - name: Install dependencies
      working-directory: qudag/qudag-napi
      run: npm ci

    - name: Build NAPI bindings (debug)
      working-directory: qudag/qudag-napi
      run: npm run build:debug

    - name: Run unit tests
      working-directory: qudag/qudag-napi
      run: npm test

    - name: Run benchmark smoke tests
      working-directory: qudag/qudag-napi
      run: npm run benchmark || echo "Benchmarks completed"

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: qudag/qudag-napi

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      working-directory: qudag/qudag-napi
      run: npm ci

    - name: Generate Rust code coverage
      working-directory: qudag/qudag-napi
      run: cargo llvm-cov --lcov --output-path lcov-rust.info

    - name: Build NAPI bindings for testing
      working-directory: qudag/qudag-napi
      run: npm run build:debug

    - name: Run tests with coverage
      working-directory: qudag/qudag-napi
      run: npm test

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: qudag/qudag-napi/lcov-rust.info
        flags: napi,rust
        name: napi-rust-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: qudag/qudag-napi

    - name: Run cargo audit
      working-directory: qudag/qudag-napi
      run: |
        cargo install cargo-audit
        cargo audit

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      working-directory: qudag/qudag-napi
      run: npm ci

    - name: Run npm audit
      working-directory: qudag/qudag-napi
      run: npm audit --audit-level=moderate
      continue-on-error: true

  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code (base)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        path: base

    - name: Checkout code (PR)
      uses: actions/checkout@v4
      with:
        path: pr

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # Build and benchmark base
    - name: Build base version
      working-directory: base/qudag/qudag-napi
      run: |
        npm ci
        npm run build

    - name: Benchmark base version
      working-directory: base/qudag/qudag-napi
      run: |
        npm run benchmark > ../../benchmark-base.txt 2>&1 || true

    # Build and benchmark PR
    - name: Build PR version
      working-directory: pr/qudag/qudag-napi
      run: |
        npm ci
        npm run build

    - name: Benchmark PR version
      working-directory: pr/qudag/qudag-napi
      run: |
        npm run benchmark > ../../benchmark-pr.txt 2>&1 || true

    - name: Compare benchmarks
      run: |
        echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Base (target branch)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat base/benchmark-base.txt >> $GITHUB_STEP_SUMMARY || echo "No base benchmarks" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### PR (current branch)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat pr/benchmark-pr.txt >> $GITHUB_STEP_SUMMARY || echo "No PR benchmarks" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: qudag/qudag-napi

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      working-directory: qudag/qudag-napi
      run: npm ci

    - name: Build NAPI bindings
      working-directory: qudag/qudag-napi
      run: npm run build

    - name: Run integration tests
      working-directory: qudag/qudag-napi
      run: npm test

    - name: Test QuDAG core compatibility
      working-directory: qudag
      run: |
        # Test that NAPI bindings work with QuDAG core
        cd qudag-napi
        node -e "
          const qudag = require('./index.js');
          console.log('Testing QuDAG NAPI bindings...');

          // Basic functionality tests
          console.log('✓ Module loaded successfully');
        "

  test-summary:
    name: Test Summary
    needs: [lint, test, coverage, security, integration]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "Lint status: ${{ needs.lint.result }}"
        echo "Test status: ${{ needs.test.result }}"
        echo "Coverage status: ${{ needs.coverage.result }}"
        echo "Security status: ${{ needs.security.result }}"
        echo "Integration status: ${{ needs.integration.result }}"

        if [[ "${{ needs.lint.result }}" != "success" ]]; then
          echo "❌ Lint checks failed"
          exit 1
        fi

        if [[ "${{ needs.test.result }}" != "success" ]]; then
          echo "❌ Tests failed"
          exit 1
        fi

        if [[ "${{ needs.integration.result }}" != "success" ]]; then
          echo "❌ Integration tests failed"
          exit 1
        fi

        # Coverage and security are allowed to fail without blocking
        if [[ "${{ needs.coverage.result }}" != "success" ]]; then
          echo "⚠️  Coverage generation had issues (non-blocking)"
        fi

        if [[ "${{ needs.security.result }}" != "success" ]]; then
          echo "⚠️  Security audit found issues (non-blocking)"
        fi

        echo "✅ All critical tests passed"
